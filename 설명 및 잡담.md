### 프로젝트명: 스마트폰과 Beacon을 이용한 무인 원격 주문 시스템

팀원 수: 4명<br>
개발 기간: 1달<br>
나의 역할: 코딩, 다이어그램<br>

사용 언어: Java, JSP<br>
사용 SDK: Android SDK, RECO SDK(for Adroid)<br>
사용 라이브러리: JSTL, GSON<br>
사용 툴: Android Studio 3.0, Eclipse Neon(4.6), Apache Tomcat 8.0, MySQL Workbench 6.3.10<br>

### 프로그램 설명
![screenshot](etc/BGMG1.png)![screenshot](etc/BGMG2.png)<br>
사진1-시작 화면 / 사진2-메뉴화면(비컨 신호가 잡히지 않아서 메뉴만 뜨고 선택은 불가능)
- 무인 주문용 앱
- 비컨을 통해 위치(지점)를 파악
- 지점에 따라 다른 메뉴를 보여줌
- 주문 내역을 웹서버를 통해 DB에 저장
- 주문이 완료되면 푸시를 통해 알림
- 지금까지의 주문 내역을 확인 가능

### 동작 과정
1. 앱 실행 시 로고 화면이 뜨고 비컨 신호를 통해 지점 파악
2. 해당 지점의 메뉴 목록을 불러옴(비컨 신호를 못 받은 경우 본점 메뉴)
3. 비컨이 잡힌 경우 메뉴 선택이 가능(+총 비용을 하단에 표시)
4. 선택 완료 시 선택한 메뉴와 가격을 보여주고 주문여부 선택 가능<br>
뒤로가기 시 메뉴 선택 화면으로 이동(선택한 메뉴는 유지)
5. 주문 시 웹서버 페이지에 주문 내역 전송<br>
웹서버를 통해 주문 내역을 DB에 저장
6. (선택)주문 내역 탭에서 현재 주문 내역을 포함한 모든 주문 내역을 확인 가능
7. 웹서버에서 주문 완료 처리 시 푸시 알림을 보냄

### 주요 기능
- 웹서버 통신
  - DB로의 직접 연결은 보안으로 인해 불가능하므로 웹서버로의 연결을 통해 DB에 접속해 결과를 얻어옴<br>
  인터넷 통신은 보안으로 인해 메인 스레드로는 불가능하므로 AsyncTask를 통해 백그라운드 스레드 영역에서 작업
  - 관련 데이터를 웹서버로 보내면 웹서버에서 쿼리문으로 바꾸어 DB에서 결과를 얻은 후<br>
  GSON을 이용해 JSON 형태로 바꾸어 앱에 결과를 반환
  - 받아온 데이터를 JSONArray에 넣고 JSONObject를 통해 꺼내어 사용
- 비컨 신호 확인
  - 웹서버를 통해 major, minor 값 리스트를 가져옴(major:지역, minor:지점)<br>
  받아온 값과 UUID로 regions 목록 생성(허용 비컨 리스트)<br>
  웹서버에 문제가 생긴 경우 경고문 표시 후 확인을 누르면 종료
  - 일정 시간 간격으로 비컨 신호를 받아와서 체크<br>
  주변의 모든 비컨 신호를 받아온 다음 regions 목록에 있는 것만 목록으로 생성<br>
  - 가장 거리가 가까운 비컨의 UID 값을 저장하고 메인 화면으로 이동<br>
  이후 주문 시 이 비컨과 동일한 비컨 신호를 받고있는지 체크(자리에서 벗어났는지 체크)
- 메뉴 선택
  - 단품, 세트, 사이드 형태로 탭을 생성하고 비컨이 없는 경우 주문하기 버튼과 총 비용 내역을 제거
  - 웹서버를 통해 비컨의 major, minor 값에 해당하는 메뉴와 이미지를 가져옴(지점 별 메뉴)
  - 가져온 메뉴를 종류에 따라 다른 리스트에 넣고 어댑터에 넣은 다음 리스트뷰에 어댑터를 설정<br>
  어댑터에서 이미지와 메뉴 정보를 아이템 뷰에 집어넣고 증감 버튼 클릭 이벤트를 정의<br>
  (비컨이 없으면 증감 버튼을 제거하고 이미지와 텍스트의 크기를 늘림)
  - 개수 증감 시 하단에 메뉴 종류에 맞게 개수를 증감(싱글 a개|세트 b개|사이드 c개)<br>
  이후 해당 메뉴의 가격만큼 총 비용을 증감<br>
  종류 별 개수와 총 비용은 SharedPreferences 내에서 관리
  - 주문 완료 터치 시 종류 별 메뉴를 0으로 바꾸고 주문 확인 화면으로 이동(표기 오류 방지)
- 주문 확인
  - 주문할 내역과 주문 완료 내역의 형태로 탭을 생성
  - 주문할 내역 탭에서는 선택한 메뉴의 종류 및 개수, 총 비용을 출력<br>
  주문 터치 시 비컨 신호를 재확인한 후 웹서버를 통해 주문 내역을 전송<br>
  - 주문 완료 내역에서는 지금까지 완료한 주문 내역을 웹서버를 통해 받아와서 목록으로 출력<br>
  최근 순으로 표시하고, 제작이 완료된 주문은 어두운 색으로 표시
  - 뒤로가기 시, 접근 경로에 따라 메뉴 선택 또는 메인 화면으로 이동
- 메인 화면
  - 메뉴 선택, 주문 확인 화면으로 가는 버튼이 존재
  - ViewFlipper를 통해 다수의 이미지를 슬라이드 형식으로 보여줌<br>
  일정 시간마다 자동으로 슬라이드되며, 직접 넘기기도 가능<br>
  끝에서 넘어가면 반대편 끝으로 슬라이드<br>
  시연 시엔 사용하지 않았지만, 신 메뉴 이미지나 이벤트 내역을 웹서버에서 받아오는 게 주 목적
  - 하단에 제작중인 주문 개수를 표시
  - 뒤로가기 2회 터치 시 앱 종료(1회 터치 시 종료 안내와 경고 표시)
- 제작 완료 알림
  - 매 초마다 웹서버를 통해 제작중인 주문의 개수를 얻어와서 메인 화면의 하단에 출력<br>
  - 새로 받아온 개수를 전과 비교해서 줄어들면 Notification을 통해 푸시를 날림(진동, 사운드, 빛)
  - 앱 종료 전까지만 계속 체크

### 겪었던 문제(기술)
- 액티비티 간에 이동이 제대로 되질 않음
  - 뒤로가기 키를 눌렀을 때 처음에는 잘 되지만 화면을 2번 이상 이동하거나 홈 버튼을 눌렀다가 돌아오면 이상해짐
  - 많은 시행착오 이후 모든 액티비티에 뒤로가기에 대한 동작을 재정의해 사용하는 것으로 해결
- 홈 버튼을 눌렀다 돌아오면 앱이 비정상적으로 돌아감
  - 받아왔던 메뉴 목록이나 가격, 개수 등의 목록이 날아가서 비정상적으로 표기됨
  - 정적 리스트에 넣어도 해결이 안되어서 결국 SharedPreferences에 넣어서 사용하는 것으로 해결
  - 별도로 메뉴 리스트는 메뉴 선택 화면에 들어설 때마다 받아오게 해 최신 리스트를 유지
- 홈 버튼을 눌렀다 돌아오면 자꾸 푸시가 날아옴
  - 홈 버튼으로 나갔다가 다시 들어올 때 로딩 화면이 뜬 다음 원래 액티비티로 복귀하게 되면서<br>
  로딩 화면에서의 초기화 과정을 재수행해 주문 개수가 0으로 바뀌어 푸시가 날아오게 됨
  - isTaskRoot() 함수를 통해 앱을 시작하는 게 아닌 경우엔 초기화 작업을 수행하지 않도록 변경하는 것으로 해결
- 메뉴 선택 화면의 메뉴 목록을 불러오는 게 안됨
  - 통신은 백그라운드에서 수행해야 하지만, 레이아웃 변경은 백그라운드에서는 불가능함
  - AsyncTask에서 통신은 doInBackground, 레이아웃 변경은 onExecute, onPostExecute 함수에서 처리하여 해결
- 개수와 총 비용 변경이 제대로 되질 않음
  - 뒤로가기를 통해서 나갔다가 돌아오면 메뉴 쪽의 개수는 그대로인데 하단 쪽의 개수와 비용은 초기화됨<br>
  메뉴 선택 화면을 들어갈 때 개수를 초기화하고 재계산하면서 개수 리스트는 초기화하지 않았음
  - 메뉴 선택 → 주문 확인 순으로 이동한 상태로 뒤로가기 시 개수 표기가 잘못 됨
  - 메뉴 선택 이후 메인화면에서 주문 확인 화면으로 이동하면 개수가 초기화 됨
  - TextChangeListener에서 변경 처리를 했더니 변경된 내역에 대해서 재차 호출이 되어 2번 수행이 됨
  - 등등...
  - 많은 시행착오 끝에 변경은 어댑터 내에서 증감 버튼 클릭 이벤트로 처리하고<br>
  TextChangeListener에선 변경 값을 저장시켜서 해결
- 비컨 신호가 인식이 되질 않음
  - 앱플레이어에선 블루투스 지원이 전혀 안되어서(블루투스 장치를 연결해도 동일)<br>
  비컨 관련 테스트는 팀원의 스마트폰을 통해 진행하는 것으로 일부 해결
  - RECO SDK 내의 didRangeBeaconsInRegion(Collection<RECOBeacon> recoBeacons, RECOBeaconRegion recoRegion) 함수에서<br>
  recoBeacons 변수에 신호를 받은 모든 비컨의 정보가 들어있는 줄 알았는데 단일 변수인 recoRegion에 들어있었고<br>
  신호를 받은 비컨의 개수만큼 해당 함수를 실행하는 것이었음<br>
  - recoRegion에 들어있는 비컨을 체크하고 리스트에 넣은 다음 Runnable에서 비교하는 것으로 해결

---

### 잡담

### 겪었던 문제(일상)
- iOS 개발이 불가능
  - 원래 계획은 iOS앱을 만드는 것이었음
  - 하지만 맥OS 컴퓨터가 없어서 개발을 못 함
  - Xamarin을 쓰면 윈도우에서도 개발이 가능하다는 글을 보고 하려 했으나<br>
  결국 테스트는 맥에서 돌려야 한다는 사실을 알게 됨
  - 시간이 지나 조교한테서 맥북을 받았는데 Xcode 설치가 안됨<br>
  알아보니 os를 업데이트해야 한다던데 오래된 맥북이라서 업데이트가 안되는데다 비밀번호도 모른 채 설정이 잠겨있음<br>
  결국 어떻게든 업그레이드를 하고 XCode 버전도 낮춰서 설치했지만 OS 요구 사양 부족으로 인해 맥북이 너무 느려짐
  - 어떻게든 테스트를 하려 했지만, 알아보니 개발자 등록이란 걸 해야 함<br>
  등록을 안해도 된다는 옛 글도 있었지만 결국 되지 않았고, 또한 등록에 10만원 이상이 들어감<br>
  캡스톤 대회측에서 비용 지원 범주 바깥이란 얘기를 듣고 결국 포기<br>
  (여담이지만 위에서 얘기한 블루투스 장치도 범주 밖이라 교수님 돈으로 구매한 것(SK-DG40))
  - 결국 대안으로 안드로이드 개발로 변경함

### 소감
- &nbsp;아마 가장 할 말이 많을거라 생각한다.<br><br>
&nbsp;일단 먼저 얘기할 것으로는 현재 남은 사진이 거의 없다.<br>
왜냐하면 일단 이게 안드로이드 앱인데, 정작 난 아이폰 유저다.<br>
다른 기능은 앱플레이어에서도 테스트가 가능했지만<br>
비컨은 블루투스가 필요한데 앱플레이어에선 불가능했다.<br>
비컨을 제외한 테스트 버전도 따로 있지만<br>
프로젝트가 끝난 이후에 이클립스의 새 버전이 생겼기에<br>
덮어쓰는 방식으로 업데이트를 했다가 그만 망가져버렸다.<br>
새 버전을 별도로 설치하긴 했지만 관련 세팅을 다시 해야 한다.<br>
결국 귀찮아서 포기했다.<br><br>
&nbsp;안드로이드 스튜디오를 다뤄 본 결과로는 굉장히 만족스러웠다.<br>
자바를 온통 이클립스로 다루다가 접하니 거의 비주얼 스튜디오 수준으로 편하다.<br>
자체 편의성과 기능성이 차원이 다른 게, 자바와 JSP도 이걸로 다루면 좋겠다고 느꼈다.<br><br>
&nbsp;그건 그거고, 해왔던 프로젝트 중에서 이게 가장 심적으로 힘들었던 것 같다.<br>
첫 프로젝트인 파일 매니저는 처음에 배울 게 많았을 뿐이지 프로그램은 간단해서 끝은 간단했지만<br>
이거는 초반에 쉽게 봤다가 데인 게 너무 많았다.<br><br>
&nbsp;일단 첫째로 iOS 개발을 원래 목표로 잡았지만 무려 한 달에 걸쳐서 불가능하단 결론을 얻었다.<br>
개발 기간은 2달 밖에 안되는데 여기서 절반이나 날려먹었다.<br>
또한 웹서버의 경우는 저번 학기에 만든 프로젝트를 일부만 수정하면 됐기에 문제가 덜 했지만<br>
그나마도 통신에 웹서버를 요구하기에 별도로 GSON까지 설치하면서 뒤늦게 이것저것 추가해야 했다.<br>
안드로이드 개발에서도 Beacon이 어떻게 작동하고 어떻게 SDK를 써야하는지 이해하는데 시간이 많이 걸렸고<br>
안드로이드 생명주기에 대한 세세한 정보가 보이질 않아서 제대로 이해하지도 못했으며<br>
넷상의 예제 상당수가 버전이 올라가면서 다른 방법을 쓰도록 바뀌어서 새로운 형태에 맞게 바꾸는 것도 힘들었다.<br>
특히 커스텀 Adapter와 ViewHolder 형식을 통한 커스텀 리스트뷰의 이해가 가장 힘들었던 것 같다.<br><br>
&nbsp;그런데 사실 이 중에서 iOS를 포기한 건 당시에도, 지금 생각해도 결국 나은 선택이라 생각한다.<br>
그대로 갔으면 맥OS에 적응을 해야했고, XCode에 적응을 해야 했으며, Swift를 배워야 했다.<br>
모르긴 몰라도 상황이 더 안좋았을 것이고, 결국 기간 내에 만들지도 못했을거라 생각한다.<br>
물론 안드로이드로 바꾼 현재도 1달 밖에 없어서 거의 무리이긴 매한가였지만 말이다.<br>
실제로도 발표 5일 전 쯤에 완료되기도 했고.<br><br>
&nbsp;아무튼 고생이야 미친듯이 했지만 결국 끝났고, 무엇보다 이 강의는 시험이 없어서 좋았다.<br>
파일 매니저를 만들 때는 중간 기말 다 보고 시험 난이도도 높아서 힘들었던 걸 생각하면 나름 편하다.<br>
원래 발표를 12월 1일? 인가에 해야 한다고 알고있는데 문제 해결을 못하고 있어서 정말 망한 줄 알았는데<br>
결국 직전에 거의 완성은 하고 나서 알고보니 7일이 발표일이라 엄청나게 안심했던 기억이 있다.<br>
그래서 남은 날은 마음놓고 다른 프로젝트랑 시험에만 집중했다.(발표장에도 안가고 상금만 받았다)<br>
사진이 부족한 건 나중에 필요하면 세팅해서 넣던가 해야겠다.
